# =============================================================================
# Visual Regression Testing Workflow
# =============================================================================
# Runs Playwright visual regression tests to catch unintended UI changes
# Triggered on push to main/develop and PRs
# SECURITY: This workflow only runs on the production repository

name: Visual Regression Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:  # Allow manual trigger

concurrency:
  group: visual-regression-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PRODUCTION_REPO: 'ry86pkqf74-rgb/researchflow-production'

jobs:
  visual-regression:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    # Only run on production repository
    if: github.repository == 'ry86pkqf74-rgb/researchflow-production'

    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: ros
          POSTGRES_PASSWORD: ros
          POSTGRES_DB: ros
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        env:
          CI: true

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Create .env file
        run: |
          cp .env.example .env
          echo "" >> .env
          echo "# CI Override" >> .env
          echo "GOVERNANCE_MODE=DEMO" >> .env
          echo "JWT_SECRET=ci-test-secret-minimum-32-characters-required" >> .env
          echo "AUTH_ALLOW_STATELESS_JWT=true" >> .env
          echo "DASHBOARD_ENABLED=true" >> .env
          echo "CHAT_AGENT_ENABLED=false" >> .env
          echo "DATABASE_URL=postgresql://ros:ros@localhost:5432/ros" >> .env
          echo "REDIS_URL=redis://localhost:6379" >> .env

      - name: Build and start services
        run: |
          docker compose build --no-cache orchestrator worker web
          docker compose up -d postgres redis
          sleep 10
          docker compose up -d orchestrator worker web
          sleep 45

      - name: Wait for services
        run: |
          echo "Waiting for orchestrator..."
          timeout 120 bash -c 'until curl -sf http://localhost:3001/health; do sleep 3; done'
          echo "Orchestrator healthy!"

          echo "Waiting for web..."
          timeout 60 bash -c 'until curl -sf http://localhost:5173; do sleep 3; done'
          echo "Web healthy!"

      - name: Run visual regression tests
        run: npm run test:visual
        env:
          CI: true
          BASE_URL: http://localhost:5173
          API_URL: http://localhost:3001
          PLAYWRIGHT_BASE_URL: http://localhost:5173

      - name: Upload visual regression report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-regression-report
          path: |
            playwright-report/
            test-results/
          retention-days: 14

      - name: Upload baseline screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-baseline-screenshots
          path: tests/visual/__screenshots__/
          retention-days: 7

      - name: Comment on PR with visual test results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'playwright-report/results.json';

            if (fs.existsSync(reportPath)) {
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              const passed = report.stats?.passes || 0;
              const failed = report.stats?.failures || 0;
              const skipped = report.stats?.skipped || 0;

              let comment = `## üì∏ Visual Regression Test Results\n\n`;
              comment += `| Status | Count |\n`;
              comment += `|--------|-------|\n`;
              comment += `| ‚úÖ Passed | ${passed} |\n`;
              comment += `| ‚ùå Failed | ${failed} |\n`;
              comment += `| ‚äò Skipped | ${skipped} |\n\n`;

              if (failed > 0) {
                comment += `**‚ö†Ô∏è Visual regression detected!** Please review the [detailed report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).\n`;
              } else {
                comment += `**‚úÖ All visual regression tests passed!**\n`;
              }

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: Show container logs on failure
        if: failure()
        run: |
          echo "=== Orchestrator Logs ==="
          docker compose logs orchestrator --tail=100 || true
          echo "=== Web Logs ==="
          docker compose logs web --tail=100 || true

      - name: Stop services
        if: always()
        run: docker compose down -v || true
