apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: researchflow-ingress
  namespace: researchflow
  labels:
    app.kubernetes.io/name: researchflow
    app.kubernetes.io/component: ingress
    researchflow.io/phase: phase-d
    researchflow.io/task: "69"
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "120"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "120"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"

    # ===========================================
    # DDoS Protection Settings (Task 69)
    # ===========================================

    # Global rate limiting - 100 requests per second per IP
    nginx.ingress.kubernetes.io/limit-rps: "100"
    # Burst allowance for legitimate traffic spikes
    nginx.ingress.kubernetes.io/limit-burst-multiplier: "5"
    # Connection limiting - max 50 concurrent connections per IP
    nginx.ingress.kubernetes.io/limit-connections: "50"
    # Whitelist internal health check IPs (add actual IPs in production)
    nginx.ingress.kubernetes.io/limit-whitelist: "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"

    # Request size limits to prevent large payload attacks
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/client-body-buffer-size: "1m"

    # Timeout settings to prevent slowloris attacks
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "10"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"

    # Security headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      # Prevent clickjacking
      add_header X-Frame-Options "SAMEORIGIN" always;
      # Prevent MIME type sniffing
      add_header X-Content-Type-Options "nosniff" always;
      # Enable XSS filter
      add_header X-XSS-Protection "1; mode=block" always;
      # Strict Transport Security
      add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
      # Referrer Policy
      add_header Referrer-Policy "strict-origin-when-cross-origin" always;
      # Content Security Policy (adjust as needed)
      add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https:;" always;
      # Block common attack patterns
      if ($request_uri ~* "(union.*select|insert.*into|delete.*from|drop.*table|update.*set)" ) {
        return 403;
      }
      # Block suspicious user agents
      if ($http_user_agent ~* "(nikto|sqlmap|nessus|nmap|masscan)" ) {
        return 403;
      }

    # Enable ModSecurity WAF if available
    nginx.ingress.kubernetes.io/enable-modsecurity: "true"
    nginx.ingress.kubernetes.io/enable-owasp-core-rules: "true"
    nginx.ingress.kubernetes.io/modsecurity-snippet: |
      SecRuleEngine On
      SecRequestBodyAccess On
      SecRequestBodyLimit 52428800
      SecRequestBodyNoFilesLimit 524288
spec:
  tls:
    - hosts:
        - researchflow.example.com
      secretName: researchflow-tls
  rules:
    - host: researchflow.example.com
      http:
        paths:
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: orchestrator
                port:
                  number: 3001
          - path: /
            pathType: Prefix
            backend:
              service:
                name: web
                port:
                  number: 80
