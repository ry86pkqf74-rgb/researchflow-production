# Test container for manuscript-engine
FROM node:20-alpine

# Install necessary build tools
RUN apk add --no-cache \
    git \
    python3 \
    make \
    g++

WORKDIR /workspace

# Copy workspace-level dependencies
COPY package*.json ./
COPY tsconfig.json ./
COPY vitest.config.ts ./

# Copy all packages (needed for workspace dependencies)
COPY packages/core ./packages/core
COPY packages/ai-router ./packages/ai-router
COPY packages/manuscript-engine ./packages/manuscript-engine

# Install dependencies at workspace level
RUN npm ci

# Build dependencies
RUN npm run build -w packages/core || true
RUN npm run build -w packages/ai-router || true

# Set working directory to manuscript-engine
WORKDIR /app

# Default command
CMD ["npm", "test"]
