{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://researchflow.ai/schemas/ai_invocation_event.json",
  "title": "AI Invocation Event",
  "description": "Schema for ai.invocation.completed events emitted to the ros:insights Redis stream for transparency and interpretability tracking",
  "type": "object",
  "required": [
    "invocation_id",
    "timestamp",
    "governance_mode",
    "project_id",
    "caller",
    "tier",
    "provider",
    "model"
  ],
  "properties": {
    "invocation_id": {
      "type": "string",
      "format": "uuid",
      "description": "Unique identifier for this AI invocation",
      "examples": ["550e8400-e29b-41d4-a716-446655440000"]
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO8601 timestamp of when the invocation completed",
      "examples": ["2026-01-28T14:30:00.000Z"]
    },
    "governance_mode": {
      "type": "string",
      "enum": ["DEMO", "LIVE"],
      "description": "Governance mode - DEMO uses synthetic data, LIVE requires PHI compliance"
    },
    "project_id": {
      "type": "string",
      "format": "uuid",
      "description": "Project/research ID this invocation belongs to"
    },
    "run_id": {
      "type": ["string", "null"],
      "format": "uuid",
      "description": "Workflow run ID if part of a pipeline execution"
    },
    "stage": {
      "type": ["integer", "null"],
      "minimum": 1,
      "maximum": 20,
      "description": "Workflow stage number (1-20) if part of pipeline"
    },
    "stage_name": {
      "type": ["string", "null"],
      "description": "Human-readable stage name",
      "examples": ["topic_declaration", "literature_review", "statistical_analysis"]
    },
    "caller": {
      "type": "string",
      "enum": ["orchestrator", "worker", "web"],
      "description": "Service that initiated the AI call"
    },
    "tier": {
      "type": "string",
      "enum": ["NANO", "MINI", "FRONTIER"],
      "description": "Model tier classification for cost/capability routing"
    },
    "provider": {
      "type": "string",
      "description": "AI provider name",
      "examples": ["anthropic", "openai", "together"]
    },
    "model": {
      "type": "string",
      "description": "Specific model identifier",
      "examples": ["claude-3-5-sonnet-20241022", "gpt-4o", "claude-opus-4-5-20251101"]
    },
    "purpose": {
      "type": "string",
      "enum": ["route", "generate", "rag", "refine", "classify", "extract", "summarize", "validate"],
      "description": "Purpose classification for the AI call"
    },
    "prompt_ref": {
      "type": ["string", "null"],
      "format": "uri",
      "description": "URI to the full prompt artifact (stored separately)",
      "examples": ["artifact://prompts/550e8400-e29b-41d4-a716-446655440000"]
    },
    "output_ref": {
      "type": ["string", "null"],
      "format": "uri",
      "description": "URI to the full output artifact (stored separately)",
      "examples": ["artifact://outputs/550e8400-e29b-41d4-a716-446655440000"]
    },
    "prompt_redacted": {
      "type": ["string", "null"],
      "maxLength": 500,
      "description": "Redacted/truncated prompt preview for transparency reports"
    },
    "output_redacted": {
      "type": ["string", "null"],
      "maxLength": 500,
      "description": "Redacted/truncated output preview for transparency reports"
    },
    "phi": {
      "type": "object",
      "description": "PHI scanning results for input and output",
      "properties": {
        "input_scan": {
          "$ref": "#/definitions/phi_scan_result"
        },
        "output_scan": {
          "$ref": "#/definitions/phi_scan_result"
        }
      }
    },
    "usage": {
      "type": "object",
      "description": "Token usage and cost metrics",
      "properties": {
        "input_tokens": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of input tokens consumed"
        },
        "output_tokens": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of output tokens generated"
        },
        "total_tokens": {
          "type": "integer",
          "minimum": 0,
          "description": "Total tokens (input + output)"
        },
        "cost_usd": {
          "type": "number",
          "minimum": 0,
          "description": "Estimated cost in USD"
        },
        "latency_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Total latency in milliseconds"
        },
        "time_to_first_token_ms": {
          "type": ["integer", "null"],
          "minimum": 0,
          "description": "Time to first token for streaming responses"
        }
      },
      "required": ["input_tokens", "output_tokens", "cost_usd", "latency_ms"]
    },
    "parameters": {
      "type": "object",
      "description": "Model parameters used for this invocation",
      "properties": {
        "temperature": {
          "type": "number",
          "minimum": 0,
          "maximum": 2
        },
        "max_tokens": {
          "type": "integer",
          "minimum": 1
        },
        "top_p": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "stop_sequences": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "routing": {
      "type": "object",
      "description": "Routing decision metadata",
      "properties": {
        "initial_tier": {
          "type": "string",
          "enum": ["NANO", "MINI", "FRONTIER"]
        },
        "escalated": {
          "type": "boolean",
          "description": "Whether the call was escalated to a higher tier"
        },
        "escalation_reason": {
          "type": ["string", "null"],
          "description": "Reason for tier escalation if applicable"
        },
        "quality_gate_passed": {
          "type": "boolean",
          "description": "Whether the output passed quality gates"
        },
        "features": {
          "type": "object",
          "description": "Features used for routing decision",
          "additionalProperties": true
        }
      }
    },
    "status": {
      "type": "string",
      "enum": ["SUCCESS", "FAILED", "BLOCKED", "TIMEOUT", "RATE_LIMITED"],
      "default": "SUCCESS",
      "description": "Outcome status of the invocation"
    },
    "error": {
      "type": ["object", "null"],
      "description": "Error details if status is not SUCCESS",
      "properties": {
        "code": { "type": "string" },
        "message": { "type": "string" },
        "retryable": { "type": "boolean" }
      }
    },
    "tags": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Custom tags for filtering and grouping",
      "examples": [["critical-path", "manuscript-generation", "stage-18"]]
    },
    "agent_id": {
      "type": ["string", "null"],
      "description": "Agent profile ID if using domain-specific agent",
      "examples": ["biostatistics", "surgical_outcomes", "manuscript_writing"]
    },
    "user_id": {
      "type": ["string", "null"],
      "format": "uuid",
      "description": "User who initiated the workflow containing this invocation"
    },
    "tenant_id": {
      "type": ["string", "null"],
      "description": "Organization/tenant identifier for multi-tenancy"
    }
  },
  "definitions": {
    "phi_scan_result": {
      "type": "object",
      "properties": {
        "status": {
          "type": "string",
          "enum": ["clean", "flagged", "redacted", "skipped"],
          "description": "PHI scan outcome"
        },
        "phi_types_detected": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Types of PHI detected",
          "examples": [["name", "mrn", "date_of_birth"]]
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Confidence score of PHI detection"
        },
        "redaction_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of redactions applied"
        }
      }
    }
  },
  "additionalProperties": false
}
