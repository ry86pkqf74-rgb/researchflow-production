name: PR Size Guard

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  MAX_CHANGED_LINES: 1500

jobs:
  check-pr-size:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR Size
        run: |
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}

          STATS=$(git diff --shortstat $BASE_SHA...$HEAD_SHA)
          echo "Diff stats: $STATS"

          ADDITIONS=$(echo "$STATS" | grep -oP '\d+(?= insertion)' || echo 0)
          DELETIONS=$(echo "$STATS" | grep -oP '\d+(?= deletion)' || echo 0)
          TOTAL=$((ADDITIONS + DELETIONS))

          echo "Total changed lines: $TOTAL"
          echo "Threshold: $MAX_CHANGED_LINES"

          if [ "$TOTAL" -gt "$MAX_CHANGED_LINES" ]; then
            echo "::error::PR too large ($TOTAL lines changed). Please split into smaller PRs."
            echo "Tip: Use feature flags, extract refactors, or stack PRs."
            exit 1
          fi

          echo "âœ… PR size is acceptable ($TOTAL lines)"
