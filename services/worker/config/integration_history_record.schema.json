{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://example.org/schemas/integration_history_record.schema.json",
  "title": "Integration History Record",
  "description": "Append-only log entry for integration operations (linking, deduplication, validation, quarantine)",
  "type": "object",
  "required": [
    "run_id",
    "timestamp_utc",
    "operation",
    "dataset",
    "entity",
    "rule_version",
    "rule_hash",
    "rows_in",
    "rows_out",
    "rows_affected",
    "warnings",
    "errors",
    "input_artifacts",
    "output_artifacts"
  ],
  "properties": {
    "run_id": {
      "type": "string",
      "description": "Unique identifier for this integration run (UUID or timestamp-based)",
      "pattern": "^[a-zA-Z0-9_-]+$"
    },
    "timestamp_utc": {
      "type": "string",
      "description": "ISO 8601 UTC timestamp when operation started",
      "format": "date-time"
    },
    "operation": {
      "type": "string",
      "description": "Type of integration operation performed",
      "enum": [
        "link",
        "dedupe",
        "validate",
        "quarantine",
        "pass",
        "fail"
      ]
    },
    "dataset": {
      "type": "string",
      "description": "Dataset identifier (e.g., thyroid_pilot, imaging_v2)",
      "pattern": "^[a-z0-9_]+$"
    },
    "entity": {
      "type": "string",
      "description": "Entity or rule set applied (e.g., imaging_to_surgery, molecular_to_pathology)",
      "pattern": "^[a-z0-9_]+$"
    },
    "rule_version": {
      "type": "string",
      "description": "Semantic version of rule set (e.g., 1.0.0)",
      "pattern": "^\\d+\\.\\d+\\.\\d+$"
    },
    "rule_hash": {
      "type": "string",
      "description": "SHA256 hash of rule configuration file (first 16 chars for brevity)",
      "pattern": "^[a-f0-9]{16}$"
    },
    "rows_in": {
      "type": "integer",
      "description": "Number of input rows before operation",
      "minimum": 0
    },
    "rows_out": {
      "type": "integer",
      "description": "Number of output rows after operation",
      "minimum": 0
    },
    "rows_affected": {
      "type": "integer",
      "description": "Number of rows modified/linked/quarantined by operation",
      "minimum": 0
    },
    "warnings": {
      "type": "array",
      "description": "Non-fatal warnings during operation (no PHI)",
      "items": {
        "type": "string"
      }
    },
    "errors": {
      "type": "array",
      "description": "Fatal errors during operation (no PHI)",
      "items": {
        "type": "string"
      }
    },
    "input_artifacts": {
      "type": "array",
      "description": "Paths to input files (relative to data/ root)",
      "items": {
        "type": "string",
        "pattern": "^(interim|processed)/[a-zA-Z0-9_/.]+\\.parquet$"
      }
    },
    "output_artifacts": {
      "type": "array",
      "description": "Paths to output files (relative to data/ root)",
      "items": {
        "type": "string",
        "pattern": "^(interim|processed)/[a-zA-Z0-9_/.]+\\.parquet$"
      }
    },
    "metadata": {
      "type": "object",
      "description": "Optional operation-specific metadata (no PHI)",
      "properties": {
        "execution_time_seconds": {
          "type": "number",
          "minimum": 0
        },
        "operator": {
          "type": "string",
          "description": "Human operator initials or system user (no full names)"
        },
        "python_version": {
          "type": "string"
        },
        "host_environment": {
          "type": "string",
          "enum": ["local", "ci", "staging", "production"]
        }
      }
    }
  }
}
