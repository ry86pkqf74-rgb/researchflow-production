{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://researchflow.io/schemas/job-request.json",
  "title": "JobRequest",
  "description": "Schema for job requests sent from orchestrator to worker",
  "type": "object",
  "required": ["jobId", "type", "config"],
  "properties": {
    "jobId": {
      "type": "string",
      "description": "Unique identifier for this job",
      "pattern": "^job_[a-zA-Z0-9]{12,}$"
    },
    "type": {
      "type": "string",
      "description": "Type of job to execute",
      "enum": [
        "validation",
        "analysis",
        "stage_run",
        "artifact_generation",
        "data_ingestion",
        "qc_check",
        "report_generation",
        "SPREADSHEET_CELL_PARSE"
      ]
    },
    "datasetPointer": {
      "type": "string",
      "description": "Path or URI to the dataset for processing"
    },
    "config": {
      "type": "object",
      "description": "Job-specific configuration",
      "properties": {
        "validationRules": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "List of validation rule IDs to apply"
        },
        "analysisType": {
          "type": "string",
          "enum": ["descriptive", "inferential", "predictive", "exploratory"]
        },
        "outputFormat": {
          "type": "string",
          "enum": ["json", "csv", "parquet", "html", "pdf"],
          "default": "json"
        },
        "parameters": {
          "type": "object",
          "additionalProperties": true
        }
      },
      "additionalProperties": true
    },
    "spreadsheetConfig": {
      "type": "object",
      "description": "Configuration for SPREADSHEET_CELL_PARSE jobs",
      "properties": {
        "artifactPath": {
          "type": "string",
          "description": "Path to the uploaded spreadsheet artifact"
        },
        "fileType": {
          "type": "string",
          "enum": ["csv", "xlsx", "xls", "tsv"],
          "default": "csv",
          "description": "Type of spreadsheet file"
        },
        "sheetName": {
          "type": ["string", "null"],
          "default": null,
          "description": "Sheet name for Excel files (null = first sheet)"
        },
        "blockTextConfig": {
          "type": "object",
          "description": "Block text detection settings",
          "properties": {
            "minChars": {
              "type": "integer",
              "default": 120,
              "description": "Minimum characters to classify as block text"
            },
            "minNewlines": {
              "type": "integer",
              "default": 2,
              "description": "Minimum newlines to classify as block text"
            },
            "minClinicalMarkers": {
              "type": "integer",
              "default": 1,
              "description": "Minimum clinical markers to classify as block text"
            },
            "denyColumns": {
              "type": "array",
              "items": { "type": "string" },
              "default": ["mrn", "patient_id", "dob", "ssn", "id"],
              "description": "Column names to always exclude"
            },
            "allowColumns": {
              "type": "array",
              "items": { "type": "string" },
              "default": ["ros", "clinical_notes", "op_note", "discharge_summary"],
              "description": "Column names to always include"
            }
          }
        },
        "largeSheetConfig": {
          "type": "object",
          "description": "Large sheet processing settings",
          "properties": {
            "chunkRows": {
              "type": "integer",
              "default": 50000,
              "description": "Number of rows per chunk"
            },
            "llmConcurrency": {
              "type": "integer",
              "default": 24,
              "description": "Maximum concurrent LLM requests"
            },
            "llmBatchSize": {
              "type": "integer",
              "default": 20,
              "description": "Cells per LLM batch request"
            },
            "joinBackToSheet": {
              "type": "boolean",
              "default": false,
              "description": "Whether to join extractions back to original sheet"
            },
            "enableDask": {
              "type": "boolean",
              "default": false,
              "description": "Enable Dask for parallel scanning (CSV only)"
            }
          }
        },
        "promptPack": {
          "type": "object",
          "description": "Prompt template selection",
          "properties": {
            "cellExtract": {
              "type": "string",
              "default": "cell_extract_v1",
              "description": "Default extraction prompt"
            },
            "rosExtract": {
              "type": "string",
              "default": "ros_extract_v1",
              "description": "ROS-specific extraction prompt"
            },
            "outcomeExtract": {
              "type": "string",
              "default": "outcome_extract_v1",
              "description": "Outcomes extraction prompt"
            }
          }
        }
      },
      "required": ["artifactPath"]
    },
    "stages": {
      "type": "array",
      "description": "Specific workflow stages to execute (1-19)",
      "items": {
        "type": "integer",
        "minimum": 1,
        "maximum": 19
      }
    },
    "priority": {
      "type": "string",
      "enum": ["low", "normal", "high", "critical"],
      "default": "normal"
    },
    "callbackUrl": {
      "type": "string",
      "format": "uri",
      "description": "URL to call when job completes"
    },
    "timeout": {
      "type": "integer",
      "minimum": 1000,
      "maximum": 3600000,
      "default": 300000,
      "description": "Job timeout in milliseconds"
    },
    "retryPolicy": {
      "type": "object",
      "properties": {
        "maxRetries": {
          "type": "integer",
          "minimum": 0,
          "maximum": 10,
          "default": 3
        },
        "backoffMultiplier": {
          "type": "number",
          "minimum": 1,
          "maximum": 10,
          "default": 2
        },
        "initialDelayMs": {
          "type": "integer",
          "minimum": 100,
          "maximum": 60000,
          "default": 1000
        }
      }
    },
    "metadata": {
      "type": "object",
      "description": "Metadata about the request context",
      "properties": {
        "userId": {
          "type": "string",
          "format": "uuid"
        },
        "researchId": {
          "type": "string"
        },
        "requestedAt": {
          "type": "string",
          "format": "date-time"
        },
        "correlationId": {
          "type": "string",
          "description": "ID for tracing related operations"
        },
        "governanceMode": {
          "type": "string",
          "enum": ["DEMO", "LIVE"],
          "default": "DEMO"
        }
      },
      "required": ["userId", "researchId", "requestedAt"]
    }
  },
  "additionalProperties": false
}
