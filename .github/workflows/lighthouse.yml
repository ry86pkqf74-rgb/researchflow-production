# Lighthouse CI Workflow - Task 180
# Runs Lighthouse audits on PR and reports scores

name: Lighthouse CI

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'services/web/**'
      - '.lighthouserc.json'
      - '.github/workflows/lighthouse.yml'
  push:
    branches: [main]
    paths:
      - 'services/web/**'
      - '.lighthouserc.json'

jobs:
  lighthouse:
    name: Lighthouse Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd services/web && npm ci

      - name: Build web app
        run: |
          cd services/web && npm run build
        env:
          FEATURE_PWA: 'true'

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v11
        with:
          configPath: './.lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true
          runs: 3
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Format lighthouse score
        id: format_lighthouse_score
        uses: actions/github-script@v8
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');

            // Read the manifest
            const manifest = JSON.parse(
              fs.readFileSync('.lighthouseci/manifest.json', 'utf8')
            );

            // Get the last result
            const result = manifest[manifest.length - 1];
            const summary = result.summary;

            const formatScore = (score) => {
              if (score >= 0.9) return `ðŸŸ¢ ${Math.round(score * 100)}`;
              if (score >= 0.5) return `ðŸŸ¡ ${Math.round(score * 100)}`;
              return `ðŸ”´ ${Math.round(score * 100)}`;
            };

            const comment = `## âš¡ Lighthouse Report

            | Category | Score |
            |----------|-------|
            | Performance | ${formatScore(summary.performance)} |
            | Accessibility | ${formatScore(summary.accessibility)} |
            | Best Practices | ${formatScore(summary['best-practices'])} |
            | SEO | ${formatScore(summary.seo)} |
            | PWA | ${formatScore(summary.pwa)} |

            [View full report](${result.htmlPath})
            `;

            core.setOutput('comment', comment);

      - name: Post comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const comment = `${{ steps.format_lighthouse_score.outputs.comment }}`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(
              c => c.user.login === 'github-actions[bot]' && c.body.includes('Lighthouse Report')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment,
              });
            }

  # Accessibility-specific checks
  accessibility:
    name: Accessibility Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd services/web && npm ci

      - name: Build
        run: cd services/web && npm run build

      - name: Install axe-cli
        run: npm install -g @axe-core/cli

      - name: Start preview server
        run: |
          cd services/web && npm run preview &
          sleep 5

      - name: Run axe accessibility tests
        run: |
          axe http://localhost:4173 \
            --exit \
            --save results/axe-report.json \
            --rules wcag2a,wcag2aa,wcag21a,wcag21aa,best-practice
        continue-on-error: true

      - name: Upload accessibility report
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-report
          path: results/axe-report.json
          if-no-files-found: ignore
