name: Publish Documentation

# SECURITY: This workflow only runs on the production repository
# If this code is copied to another repository, workflows will be skipped
on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - '.github/workflows/publish-docs.yml'

  # Allow manual trigger
  workflow_dispatch:

# Sets permissions for GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  # Production repository identifier
  PRODUCTION_REPO: 'ry86pkqf74-rgb/researchflow-production'

jobs:
  build:
    name: Build Documentation
    runs-on: ubuntu-latest
    # Only run on production repository
    if: github.repository == 'ry86pkqf74-rgb/researchflow-production'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-mkdocs-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-mkdocs-

      - name: Install MkDocs and dependencies
        run: |
          pip install mkdocs mkdocs-material mkdocs-minify-plugin pymdown-extensions

      - name: Create docs structure if missing
        run: |
          mkdir -p docs/getting-started
          mkdir -p docs/architecture
          mkdir -p docs/user-guide
          mkdir -p docs/api
          mkdir -p docs/operations
          mkdir -p docs/development
          mkdir -p docs/security

          # Create index.md if missing
          if [ ! -f docs/index.md ]; then
            cat > docs/index.md << 'EOF'
          # ResearchFlow Documentation

          Welcome to the ResearchFlow documentation. ResearchFlow is a comprehensive clinical research workflow platform.

          ## Quick Links

          - [Quick Start](getting-started/quickstart.md) - Get up and running quickly
          - [Architecture Overview](architecture/overview.md) - Understand the system design
          - [API Reference](api/orchestrator.md) - API documentation

          ## Features

          - **20-Stage Workflow Pipeline** - Guided research workflow from topic selection to publication
          - **Manuscript Engine** - AI-powered manuscript generation and editing
          - **Conference Preparation** - Automated poster and presentation generation
          - **PHI Safety** - Built-in HIPAA-compliant data handling

          ## Getting Help

          - Check the [FAQ](getting-started/faq.md)
          - Open an [issue on GitHub](https://github.com/ry86pkqf74-rgb/researchflow-production/issues)
          EOF
          fi

          # Create placeholder files for navigation
          for dir in getting-started architecture user-guide api operations development security; do
            if [ ! -f "docs/$dir/index.md" ]; then
              echo "# ${dir^}" > "docs/$dir/index.md"
              echo "" >> "docs/$dir/index.md"
              echo "Documentation coming soon." >> "docs/$dir/index.md"
            fi
          done

      - name: Copy existing docs
        run: |
          # Copy architecture docs
          [ -f docs/architecture/SCALE_PLAN.md ] && cp docs/architecture/SCALE_PLAN.md docs/architecture/scale-plan.md || true

          # Copy operations docs
          [ -f docs/operations/MODE_TOGGLE.md ] && cp docs/operations/MODE_TOGGLE.md docs/operations/mode-toggle.md || true
          [ -f docs/operations/BACKUPS_AND_RESTORE.md ] && cp docs/operations/BACKUPS_AND_RESTORE.md docs/operations/backups.md || true

          # Copy configuration docs
          [ -f docs/configuration/env-vars.md ] && cp docs/configuration/env-vars.md docs/getting-started/configuration.md || true

      - name: Build site
        run: mkdocs build --strict 2>/dev/null || mkdocs build

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site/

  deploy:
    name: Deploy to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    # Only run on production repository
    if: github.repository == 'ry86pkqf74-rgb/researchflow-production'
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
