// nextflow.config - ROS Workflow Configuration
// INF-1 / Task A - Workflow Orchestration Scaffolding
//
// Governance: STANDBY fail-closed by default
//   - No network calls (NO_NETWORK=1)
//   - Mock-only LLM providers (MOCK_ONLY=1)
//   - All artifacts under .tmp/ quarantine
//   - No PHI, no secrets, no content emission

// ============================================================================
// Workflow Parameters
// ============================================================================

params {
    // Runtime control
    ros_mode = 'STANDBY'        // STANDBY | SANDBOX | ACTIVE | LIVE
    no_network = true           // Enforce offline mode
    mock_only = true            // Use mock LLM providers only

    // Input/output paths (all under .tmp/ quarantine)
    input_dir = '.tmp/literature_runtime/inputs'
    output_dir = '.tmp/workflow_output'
    literature_artifacts = '.tmp/literature_runtime/artifacts'
    sourcelit_manifests = '.tmp/sourcelit_runtime/manifests'
    export_output = '.tmp/export_runs'

    // Validation configuration
    strict_validation = true    // Enforce strict schema validation
    enable_ai_qa = false        // AI QA requires ACTIVE mode (disabled in STANDBY)

    // Execution settings
    max_cpus = 1                // Sequential execution for determinism
    max_memory = '4.GB'         // Memory limit
    max_time = '1.h'            // Time limit
}

// ============================================================================
// Environment Variables (Enforce STANDBY Mode)
// ============================================================================

env {
    ROS_MODE = params.ros_mode
    NO_NETWORK = '1'
    MOCK_ONLY = '1'
    PYTHONPATH = "\$PWD/src:\$PYTHONPATH"
}

// ============================================================================
// Process Configuration
// ============================================================================

process {
    // Default process settings
    cpus = 1
    memory = '2.GB'
    time = '30.m'

    // Error strategy: fail-closed (stop on first error)
    errorStrategy = 'terminate'

    // Working directory (under .tmp/ quarantine)
    workDir = '.tmp/nextflow_work'

    // Enable conda/container isolation (optional)
    // container = 'ros-workflow:latest'  // Uncomment when container is available (INF-2)
}

// ============================================================================
// Executor Configuration
// ============================================================================

executor {
    name = 'local'              // Local execution only (no cloud/cluster)
    cpus = params.max_cpus
    memory = params.max_memory
    queueSize = 1               // Sequential execution
}

// ============================================================================
// Reporting and Tracing
// ============================================================================

// Generate execution report
report {
    enabled = true
    file = "${params.output_dir}/nextflow_report.html"
}

// Generate execution timeline
timeline {
    enabled = true
    file = "${params.output_dir}/nextflow_timeline.html"
}

// Generate execution trace
trace {
    enabled = true
    file = "${params.output_dir}/nextflow_trace.txt"
    fields = 'task_id,hash,native_id,process,tag,name,status,exit,submit,start,complete,duration,realtime,%cpu,%mem,rss,vmem,peak_rss,peak_vmem'
}

// ============================================================================
// Profiles (Optional)
// ============================================================================

profiles {
    standard {
        process.executor = 'local'
    }

    // STANDBY profile (default, fail-closed)
    standby {
        env.ROS_MODE = 'STANDBY'
        env.NO_NETWORK = '1'
        env.MOCK_ONLY = '1'
    }

    // SANDBOX profile (offline, synthetic data allowed)
    sandbox {
        env.ROS_MODE = 'SANDBOX'
        env.NO_NETWORK = '1'
        env.MOCK_ONLY = '1'
    }

    // Note: ACTIVE profile intentionally omitted
    // ACTIVE mode requires explicit governance approval and preflight checks
    // See docs/plans/INTEGRATION_SUPPLEMENT_EXECUTION_GUIDE_2026.md
}

// ============================================================================
// Manifest
// ============================================================================

manifest {
    name = 'ROS-Workflow-Orchestration'
    description = 'Optional workflow orchestration scaffolding for Research Operating System'
    author = 'ROS Integration Team'
    version = '0.1.0'
    nextflowVersion = '>=21.04.0'
}

// ============================================================================
// Notes
// ============================================================================
//
// Safety reminders:
// - This workflow is an OPTIONAL WRAPPER around existing runtimes
// - It does NOT replace or modify existing orchestrators
// - All governance gates (RuntimeConfig, Preflight) are preserved
// - Artifacts remain quarantined under .tmp/
// - STANDBY mode is fail-closed by default
//
// For ACTIVE mode execution:
// 1. Review docs/plans/INTEGRATION_SUPPLEMENT_EXECUTION_GUIDE_2026.md
// 2. Run preflight checks: python scripts/preflight_online.py
// 3. Create custom config with ACTIVE mode settings
// 4. Ensure LLM provider credentials are configured
// 5. Verify IRB approval for any real data processing
