# Blue-Green Deployment for Orchestrator
# Phase A - Task 34: Blue-Green Deployment with Argo Rollouts
#
# Deploys new version alongside current version, with manual or automated promotion

apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: orchestrator-bg
  namespace: researchflow
  labels:
    app.kubernetes.io/name: researchflow
    app.kubernetes.io/component: orchestrator
    deployment-strategy: blue-green
spec:
  replicas: 3
  revisionHistoryLimit: 5

  selector:
    matchLabels:
      app.kubernetes.io/name: researchflow
      app.kubernetes.io/component: orchestrator

  template:
    metadata:
      labels:
        app.kubernetes.io/name: researchflow
        app.kubernetes.io/component: orchestrator
    spec:
      serviceAccountName: orchestrator
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000

      containers:
      - name: orchestrator
        image: researchflow/orchestrator:latest
        imagePullPolicy: Always

        ports:
        - name: http
          containerPort: 3001
          protocol: TCP

        envFrom:
        - configMapRef:
            name: researchflow-config
        - secretRef:
            name: researchflow-secrets

        env:
        - name: NODE_ENV
          value: "production"
        - name: PORT
          value: "3001"

        resources:
          requests:
            cpu: "250m"
            memory: "512Mi"
          limits:
            cpu: "2000m"
            memory: "2Gi"

        livenessProbe:
          httpGet:
            path: /healthz
            port: 3001
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3

        readinessProbe:
          httpGet:
            path: /readyz
            port: 3001
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 2

        startupProbe:
          httpGet:
            path: /healthz
            port: 3001
          periodSeconds: 5
          failureThreshold: 12

        volumeMounts:
        - name: shared-data
          mountPath: /data

      volumes:
      - name: shared-data
        persistentVolumeClaim:
          claimName: researchflow-data

  strategy:
    blueGreen:
      # Active service receives production traffic
      activeService: orchestrator-active

      # Preview service for testing new version
      previewService: orchestrator-preview

      # Manual promotion (set to true for auto-promotion)
      autoPromotionEnabled: false

      # Seconds to wait before scaling down old version
      scaleDownDelaySeconds: 300  # 5 minutes

      # Rollback window (optional)
      scaleDownDelayRevisionLimit: 2

      # Pre-promotion analysis
      prePromotionAnalysis:
        templates:
        - templateName: success-rate
        args:
        - name: service-name
          value: orchestrator-preview
        - name: namespace
          value: researchflow

      # Post-promotion analysis
      postPromotionAnalysis:
        templates:
        - templateName: success-rate
        args:
        - name: service-name
          value: orchestrator-active
        - name: namespace
          value: researchflow

---
# Active Service (Production Traffic)
apiVersion: v1
kind: Service
metadata:
  name: orchestrator-active
  namespace: researchflow
  labels:
    app.kubernetes.io/name: researchflow
    app.kubernetes.io/component: orchestrator
    service-type: active
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: researchflow
    app.kubernetes.io/component: orchestrator
  ports:
  - name: http
    port: 3001
    targetPort: 3001
    protocol: TCP

---
# Preview Service (New Version Testing)
apiVersion: v1
kind: Service
metadata:
  name: orchestrator-preview
  namespace: researchflow
  labels:
    app.kubernetes.io/name: researchflow
    app.kubernetes.io/component: orchestrator
    service-type: preview
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: researchflow
    app.kubernetes.io/component: orchestrator
  ports:
  - name: http
    port: 3001
    targetPort: 3001
    protocol: TCP

---
# ServiceAccount for Orchestrator
apiVersion: v1
kind: ServiceAccount
metadata:
  name: orchestrator
  namespace: researchflow
  labels:
    app.kubernetes.io/name: researchflow
    app.kubernetes.io/component: orchestrator
