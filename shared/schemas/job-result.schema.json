{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://researchflow.io/schemas/job-result.json",
  "title": "JobResult",
  "description": "Schema for job results returned from worker to orchestrator",
  "type": "object",
  "required": ["jobId", "status", "completedAt"],
  "properties": {
    "jobId": {
      "type": "string",
      "description": "Unique identifier for this job",
      "pattern": "^job_[a-zA-Z0-9]{12,}$"
    },
    "status": {
      "type": "string",
      "enum": ["completed", "failed", "cancelled", "timeout"],
      "description": "Final status of the job"
    },
    "completedAt": {
      "type": "string",
      "format": "date-time",
      "description": "Timestamp when job finished"
    },
    "duration": {
      "type": "integer",
      "minimum": 0,
      "description": "Job duration in milliseconds"
    },
    "stagesCompleted": {
      "type": "array",
      "items": {
        "type": "integer",
        "minimum": 1,
        "maximum": 19
      },
      "description": "List of successfully completed stages"
    },
    "result": {
      "type": "object",
      "description": "Job-specific result data",
      "properties": {
        "summary": {
          "type": "object",
          "description": "High-level summary of results"
        },
        "metrics": {
          "type": "object",
          "description": "Computed metrics or statistics"
        },
        "warnings": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "code": { "type": "string" },
              "message": { "type": "string" },
              "severity": { "type": "string", "enum": ["low", "medium", "high"] }
            }
          }
        }
      },
      "additionalProperties": true
    },
    "datasetOutput": {
      "type": "object",
      "description": "Output dataset metadata for large-data processing (Phase 4)",
      "properties": {
        "outputPath": {
          "type": "string",
          "description": "Path to output file or directory"
        },
        "format": {
          "type": "string",
          "enum": ["parquet", "csv", "json"],
          "description": "Output file format"
        },
        "partitioned": {
          "type": "boolean",
          "description": "True if output is split across multiple partition files"
        },
        "partitionPaths": {
          "type": "array",
          "items": { "type": "string" },
          "description": "List of partition file paths (if partitioned)"
        },
        "rowCount": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of rows in output"
        },
        "columnCount": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of columns in output"
        },
        "totalBytes": {
          "type": "integer",
          "minimum": 0,
          "description": "Total size of output in bytes"
        },
        "checksum": {
          "type": "string",
          "description": "SHA-256 checksum of output (or manifest checksum if partitioned)"
        },
        "compression": {
          "type": "string",
          "enum": ["snappy", "gzip", "lz4", "zstd", "none"],
          "description": "Compression codec used"
        },
        "createdAt": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp when output was created"
        }
      },
      "required": ["outputPath", "format", "partitioned", "rowCount", "columnCount"]
    },
    "artifacts": {
      "type": "array",
      "description": "List of artifacts generated by the job",
      "items": {
        "type": "object",
        "required": ["artifactId", "type", "path"],
        "properties": {
          "artifactId": {
            "type": "string",
            "pattern": "^art_[a-zA-Z0-9]{12,}$"
          },
          "type": {
            "type": "string",
            "enum": ["figure", "table", "report", "dataset", "log", "manifest"]
          },
          "name": {
            "type": "string"
          },
          "path": {
            "type": "string",
            "description": "Path within the shared artifact storage"
          },
          "mimeType": {
            "type": "string"
          },
          "sizeBytes": {
            "type": "integer",
            "minimum": 0
          },
          "checksum": {
            "type": "string",
            "description": "SHA-256 checksum of the artifact"
          }
        }
      }
    },
    "manifest": {
      "type": "object",
      "description": "Run manifest with full execution details",
      "properties": {
        "manifestId": {
          "type": "string"
        },
        "stages": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "stageNumber": { "type": "integer" },
              "name": { "type": "string" },
              "status": { "type": "string" },
              "startedAt": { "type": "string", "format": "date-time" },
              "completedAt": { "type": "string", "format": "date-time" },
              "outputs": { "type": "array", "items": { "type": "string" } }
            }
          }
        }
      }
    },
    "error": {
      "type": "object",
      "description": "Error details if job failed",
      "properties": {
        "code": {
          "type": "string",
          "description": "Error code for programmatic handling"
        },
        "message": {
          "type": "string",
          "description": "Human-readable error message"
        },
        "stage": {
          "type": "integer",
          "description": "Stage number where failure occurred"
        },
        "retryable": {
          "type": "boolean",
          "default": false
        },
        "details": {
          "type": "object",
          "additionalProperties": true
        }
      },
      "required": ["code", "message"]
    },
    "resourceUsage": {
      "type": "object",
      "description": "Resource consumption metrics",
      "properties": {
        "cpuSeconds": { "type": "number" },
        "memoryPeakMb": { "type": "number" },
        "ioReadBytes": { "type": "integer" },
        "ioWriteBytes": { "type": "integer" }
      }
    }
  },
  "additionalProperties": false
}
